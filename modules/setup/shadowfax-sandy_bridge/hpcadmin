#%Module1.0#############################################################################################################
###
### custom EasyBuild setup module for VBI HPC systems.
### This module is specific for environment maintained by HPC administrators in a global location
###
### originally based on work done by JÃ¼lich Supercomputing Centre (JSC)

#######################################################################################################################
# global configuration

# set up paths for the global software repository
set root "/apps"
# set our site
set site "shadowfax"
# set our organization
set org "vbi"
# set our architecture
set arch "sandy_bridge"


# # permissions and ownerships
# set easybuild_group "hpcadmin"
# set easybuild_umask "002"
# set easybuild_set_gid_bit "1"
# set easybuild_sticky_bit "1"


# end of global configuration
#######################################################################################################################


# help functions
proc ModulesHelp { } {
  puts stderr "  This module will load the required environment to prepare for managing software installations"
  puts stderr "  with EasyBuild on $site with $arch architecture. \n"
}

module-whatis "Module for setting up EasyBuild development environment on $site with $arch."

# start the module
if { [ module-info mode load ] } {
    puts stderr "\nPreparing EasyBuild environment for $site with $arch. \n"
}



# what's the location of our dummy module, which indicates that we're installing EasyBuild
# set easybuild_install_module "test/dom/EasyBuild-install"

# paths
if { [ module-info mode load ] } {
    puts stderr "* Setting environment variables for EasyBuild's directories"
}

# originally started by providing EASYBUILD_PREFIX, then switched to more split view
# setenv EASYBUILD_PREFIX $root/easybuild/$site-$arch
# setenv EASYBUILD_INSTALLPATH $root/easybuild/$site-arch

# trying to use a config file to pre-pend ROBOT_PATHS, since that function has not been
# extended to environment variables yet
setenv EASYBUILD_CONFIGFILES $root/easybuild/config/generic/hpcadmin.cfg,$root/easybuild/config/$site-$arch/hpcadmin.cfg


# setenv EASYBUILD_SUBDIR_MODULES $root/easybuild/modules/$site-$arch
setenv EASYBUILD_INSTALLPATH_SOFTWARE $root/easybuild/software/$site-$arch
# setenv EASYBUILD_SOURCEPATH $root/easybuild/sources
# setenv EASYBUILD_REPOSITORYPATH $root/easybuild/ebfiles_repo/$site-$arch
# setenv EASYBUILD_ROBOT $root/easybuild/ebfiles_repo-$org/generic:$root/easybuild/ebfiles_repo-$org/$site-$arch:$root/easybuild/ebfiles_repo/$site-$arch
# # use /dev/shm for building software
setenv EASYBUILD_BUILDPATH /dev/shm/$::env(USER)/build


# # permissions
# if { [ module-info mode load ] } {
#     puts stderr "* Setting environment variables for EasyBuild's permissions"
# }
# setenv EASYBUILD_GROUP $easybuild_group
# setenv EASYBUILD_UMASK $easybuild_umask
# setenv EASYBUILD_SET_GID_BIT $easybuild_set_gid_bit
# setenv EASYBUILD_STICKY_BIT $easybuild_sticky_bit


# global options
# if { [ module-info mode load ] } {
#     puts stderr "* Setting environment variables for EasyBuild's global options"
# }
# setenv EASYBUILD_MODULES_TOOL EnvironmentModulesC
# setenv EASYBUILD_REPOSITORY FileRepository
# setenv EASYBUILD_MODULE_NAMING_SCHEME HierarchicalMNS
# setenv EASYBUILD_ALLOW_MODULES_TOOL_MISMATCH 1

# if { [ module-info mode load ] } {
#     puts stderr "* Setting environment variables for loading EasyBuild module"
# }
# allow EasyBuild to find the modulecmd binary directly
append-path     PATH    "$::env(MODULESHOME)/bin"

# make sure we can load EasyBuild module manually
append-path MODULEPATH  "$root/easybuild/modules/$site-$arch/all"

#  this section is not used, since we may be triggering an issue in EasyBuild
# # if EasyBuild-install module is loaded, then we assume we are trying to install EasyBuild
# # otherwise, we are going to load the EasyBuild module
# if { [ is-loaded $easybuild_install_module ] } {
#     if { [ module-info mode load ] } {
#         puts stderr "* EasyBuild-install module is loaded - we're ready for initial EasyBuild install"
#     }
# } else {
#     if { [ module-info mode load ] } {
#         puts stderr "* Loading EasyBuild module"
#     }
#     # make sure we can load EasyBuild module
#     module use $root/easybuild/modules/all/Core
#     # load the EasyBuild module
#     module load EasyBuild
# }

#  final empty line
if { [ module-info mode load ] } {
    puts stderr "* End of EasyBuild init procedure \n"
    puts stderr " If you're an adminstrator please be sure to run the following: "
    puts stderr ""
    puts stderr "newgrp hpcadmin"
    puts stderr "umask 002"
    puts stderr "module load EasyBuild"
    puts stderr ""
    puts stderr " To list all available modules please use 'module avail'"
    puts stderr ""
}


# system ls

# if { [ module-info mode load ] } {
#     puts stderr "* debug \n"
#     puts stderr "- ModulesCurrentModulefile is $ModulesCurrentModulefile \n"
#     puts stderr "- foobar is foobar \n"


# }
